{% extends "base.html" %} 
{% block content %}

<div class="search-container">
    <form method="get" action="" class="search-form">
        <div class="search-input-group">
            <input
                type="text"
                name="prompt"
                placeholder="여행지 조건을 입력해보세요! (예: 강원도에서 단풍 구경하면서 조용히 힐링할 수 있는 곳)"
                value="{{ prompt }}"
                class="search-input"
            />
            <button type="submit" class="search-button">🔍 추천받기</button>
        </div>
        
        {% if show_followup %}
        <div class="followup-section">
            <strong>🤔 {{ question }}</strong>
            <div class="followup-input-group">
                <input type="text" name="followup" placeholder="답변을 입력하세요" class="followup-input" />
                <button type="submit" class="followup-button">답변 제출</button>
            </div>
        </div>
        {% endif %}
    </form>

    {% if recommended_places and not show_followup %}
    <div class="results-section">
        <div class="results-header">
            <h2>🎯 추천 여행지</h2>
            <div class="results-info">
                <span class="total-count">총 {{ total_results }}개 결과</span>
                {% if extracted_region %}
                <span class="extracted-region">📍 {{ extracted_region }}</span>
                {% endif %}
                {% if user_tags %}
                <span class="extracted-tags">🏷️ {{ user_tags|join:", " }}</span>
                {% endif %}
            </div>
        </div>

        <div class="recommendations-grid">
            {% for rec in recommended_places %}
            <div class="recommendation-card">
                <div class="card-header">
                    <h3 class="place-name">{{ rec.place.name }}</h3>
                    <div class="place-scores">
                        {% if rec.final_score %}
                        <span class="score final-score">📊 {{ rec.final_score|floatformat:3 }}</span>
                        {% endif %}
                        {% if rec.vector_score %}
                        <span class="score vector-score">🔍 {{ rec.vector_score|floatformat:3 }}</span>
                        {% endif %}
                        {% if rec.tag_score %}
                        <span class="score tag-score">🏷️ {{ rec.tag_score|floatformat:3 }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="place-info">
                    <p class="place-region">📍 {{ rec.place.region }}</p>
                    <p class="place-address">🏠 {{ rec.place.address }}</p>
                    <p class="place-summary">{{ rec.place.summary|default:"설명 없음"|truncatechars:150 }}</p>
                    
                    {% if rec.reason %}
                    <div class="recommendation-reason">
                        <strong>💡 추천 이유:</strong> {{ rec.reason|truncatechars:100 }}
                    </div>
                    {% endif %}
                </div>

                <div class="place-tags">
                    {% for tag in rec.place.tags.all %}
                    <span class="tag">#{{ tag.name }}</span>
                    {% empty %}
                    <span class="no-tags">태그 없음</span>
                    {% endfor %}
                </div>

                <div class="card-actions">
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'places:place_like' rec.place.pk %}" class="like-form">
                        {% csrf_token %}
                        <button type="submit" class="like-button {% if rec.place.is_liked %}liked{% endif %}">
                            {% if rec.place.is_liked %}
                            ❤️ 좋아요 취소
                            {% else %}
                            🤍 좋아요
                            {% endif %}
                        </button>
                    </form>
                    {% endif %}
                    
                    <a href="{% url 'places:place_detail' rec.place.pk %}" class="detail-link">자세히 보기</a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- 페이지네이션 -->
        {% if total_pages > 1 %}
        <div class="pagination">
            <div class="pagination-info">
                {{ current_page }} / {{ total_pages }} 페이지
            </div>
            
            <div class="pagination-controls">
                {% if current_page > 1 %}
                <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ current_page|add:'-1' }}" 
                   class="page-link prev-page">← 이전</a>
                {% endif %}
                
                <!-- 페이지 번호들 -->
                {% if total_pages <= 7 %}
                    {% for page_num in total_pages|add:"-1"|add:"1"|make_list %}
                        {% if page_num == current_page %}
                        <span class="current-page">{{ page_num }}</span>
                        {% else %}
                        <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ page_num }}" 
                           class="page-link">{{ page_num }}</a>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <!-- 많은 페이지가 있을 때 스마트 페이지네이션 -->
                    {% if current_page <= 4 %}
                        {% for page_num in "12345"|make_list %}
                            {% if page_num == current_page %}
                            <span class="current-page">{{ page_num }}</span>
                            {% else %}
                            <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ page_num }}" 
                               class="page-link">{{ page_num }}</a>
                            {% endif %}
                        {% endfor %}
                        <span class="page-ellipsis">...</span>
                        <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ total_pages }}" 
                           class="page-link">{{ total_pages }}</a>
                    {% elif current_page >= total_pages|add:"-3" %}
                        <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page=1" 
                           class="page-link">1</a>
                        <span class="page-ellipsis">...</span>
                        {% for page_num in total_pages|add:"-4"|add:"1"|make_list %}
                            {% if page_num == current_page %}
                            <span class="current-page">{{ page_num }}</span>
                            {% else %}
                            <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ page_num }}" 
                               class="page-link">{{ page_num }}</a>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page=1" 
                           class="page-link">1</a>
                        <span class="page-ellipsis">...</span>
                        {% for page_num in current_page|add:"-1"|add:"1"|make_list %}
                            {% if page_num == current_page %}
                            <span class="current-page">{{ page_num }}</span>
                            {% else %}
                            <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ page_num }}" 
                               class="page-link">{{ page_num }}</a>
                            {% endif %}
                        {% endfor %}
                        {% for page_num in current_page|add:"1"|add:"1"|make_list %}
                            <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ page_num }}" 
                               class="page-link">{{ page_num }}</a>
                        {% endfor %}
                        <span class="page-ellipsis">...</span>
                        <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ total_pages }}" 
                           class="page-link">{{ total_pages }}</a>
                    {% endif %}
                {% endif %}
                
                {% if has_next %}
                <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ current_page|add:'1' }}" 
                   class="page-link next-page">다음 →</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- 더 보기 섹션 -->
        {% if has_next %}
        <div class="more-results">
            <a href="?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}&page={{ current_page|add:'1' }}" 
               class="more-button">더 많은 추천 결과 보기 →</a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="navigation-links">
        <a href="{% url 'places:main' %}" class="back-link">← 메인으로 돌아가기</a>
    </div>
</div>

<style>
.search-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.search-form {
    margin-bottom: 30px;
}

.search-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.search-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
}

.search-input:focus {
    outline: none;
    border-color: #007bff;
}

.search-button {
    padding: 12px 24px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.search-button:hover {
    background: #0056b3;
}

.followup-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.followup-input-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.followup-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 6px;
}

.followup-button {
    padding: 10px 20px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

.results-section {
    margin-bottom: 40px;
}

.results-header {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
}

.results-header h2 {
    margin: 0 0 10px 0;
    color: #2c3e50;
}

.results-info {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    font-size: 14px;
    color: #6c757d;
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.recommendation-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.recommendation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.place-name {
    margin: 0;
    color: #2c3e50;
    font-size: 18px;
    flex: 1;
}

.place-scores {
    display: flex;
    flex-direction: column;
    gap: 5px;
    align-items: flex-end;
}

.score {
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
}

.final-score {
    background: #e3f2fd;
    color: #1976d2;
}

.vector-score {
    background: #f3e5f5;
    color: #7b1fa2;
}

.tag-score {
    background: #e8f5e8;
    color: #388e3c;
}

.place-info {
    margin-bottom: 15px;
}

.place-region, .place-address {
    margin: 5px 0;
    color: #6c757d;
    font-size: 14px;
}

.place-summary {
    margin: 10px 0;
    color: #495057;
    line-height: 1.5;
}

.recommendation-reason {
    background: #fff3cd;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    font-size: 14px;
    color: #856404;
}

.place-tags {
    margin-bottom: 15px;
}

.tag {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin: 2px 4px 2px 0;
}

.no-tags {
    color: #6c757d;
    font-style: italic;
    font-size: 14px;
}

.card-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

.like-form {
    margin: 0;
}

.like-button {
    padding: 8px 16px;
    border: 1px solid #dc3545;
    background: white;
    color: #dc3545;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
}

.like-button:hover {
    background: #dc3545;
    color: white;
}

.like-button.liked {
    background: #dc3545;
    color: white;
}

.detail-link {
    padding: 8px 16px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    transition: background-color 0.3s;
}

.detail-link:hover {
    background: #0056b3;
    color: white;
}

.pagination {
    text-align: center;
    margin: 30px 0;
}

.pagination-info {
    margin-bottom: 15px;
    color: #6c757d;
    font-size: 14px;
}

.pagination-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}

.page-link, .current-page {
    padding: 8px 12px;
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.3s;
}

.page-link {
    background: #f8f9fa;
    color: #007bff;
    border: 1px solid #dee2e6;
}

.page-link:hover {
    background: #e9ecef;
    color: #0056b3;
}

.page-ellipsis {
    padding: 8px 12px;
    color: #6c757d;
    font-weight: bold;
}

.current-page {
    background: #007bff;
    color: white;
    border: 1px solid #007bff;
}

.more-results {
    text-align: center;
    margin: 30px 0;
}

.more-button {
    display: inline-block;
    padding: 12px 24px;
    background: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-size: 16px;
    transition: background-color 0.3s;
}

.more-button:hover {
    background: #1e7e34;
    color: white;
}

.navigation-links {
    text-align: center;
    margin-top: 30px;
}

.back-link {
    color: #6c757d;
    text-decoration: none;
    font-size: 14px;
}

.back-link:hover {
    color: #495057;
}

@media (max-width: 768px) {
    .search-input-group {
        flex-direction: column;
    }
    
    .recommendations-grid {
        grid-template-columns: 1fr;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .place-scores {
        align-items: flex-start;
        margin-top: 10px;
    }
    
    .card-actions {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>

{% endblock %}