{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/search.css' %}?v={% now 'U' %}">
<form method="get" action="">
  {% if show_followup %}
    <!-- ê¸°ì¡´ ì§ˆë¬¸(ìˆ˜ì • ë¶ˆê°€, ë§í’ì„  í‘œì‹œ) -->
    <div class="chat-log">
      {# ì—¬ëŸ¬ ê°œì˜ ê³¼ê±° ì§ˆë¬¸ì„ ì§€ì›í•˜ë ¤ë©´ previous_prompts ì „ë‹¬ #}
      {% if previous_prompts %}
        {% for p in previous_prompts %}
          <div class="bubble bubble-user">{{ p }}</div>
        {% endfor %}
      {% else %}
        <div class="bubble bubble-user">{{ prompt }}</div>
      {% endif %}
    </div>

    {# ì„œë²„ë¡œ ê¸°ì¡´ ì§ˆë¬¸ì„ ë„˜ê¸°ê¸° ìœ„í•œ hidden í•„ë“œ #}
    {% if previous_prompts %}
      {% for p in previous_prompts %}
        <input type="hidden" name="previous_prompts" value="{{ p }}">
      {% endfor %}
    {% else %}
      <input type="hidden" name="prompt" value="{{ prompt }}">
    {% endif %}

    <!-- ë³´ì¶© ì§ˆë¬¸ ì˜ì—­ -->
    <div class="additional_ques">
      <strong>ğŸ¤” {{ question }}</strong>
      <input type="text" name="followup" value="{{ followup }}" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button type="submit" aria-label="ë³´ì¶© ë‹µë³€ ì œì¶œ">
        <!-- ì•„ì´ì½˜ ìƒëµ(ì›ë¬¸ ê·¸ëŒ€ë¡œ) -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M23.119.882a2.966,2.966,0,0,0-2.8-.8l-16,3.37a4.995,4.995,0,0,0-2.853,8.481L3.184,13.65a1,1,0,0,1,.293.708v3.168a2.965,2.965,0,0,0,.3,1.285l-.008.007.026.026A3,3,0,0,0,5.157,20.2l.026.026.007-.008a2.965,2.965,0,0,0,1.285.3H9.643a1,1,0,0,1,.707.292l1.717,1.717A4.963,4.963,0,0,0,15.587,24a5.049,5.049,0,0,0,1.605-.264,4.933,4.933,0,0,0,3.344-3.986L23.911,3.715A2.975,2.975,0,0,0,23.119.882ZM4.6,12.238,2.881,10.521a2.94,2.94,0,0,1-.722-3.074,2.978,2.978,0,0,1,2.5-2.026L20.5,2.086,5.475,17.113V14.358A2.978,2.978,0,0,0,4.6,12.238Zm13.971,7.17a3,3,0,0,1-5.089,1.712L11.762,19.4a2.978,2.978,0,0,0-2.119-.878H6.888L21.915,3.5Z"/></svg>
      </button>
    </div>
  {% else %}
    <!-- ìµœì´ˆ ê²€ìƒ‰ ìƒíƒœ: ê¸°ì¡´ ì…ë ¥ì°½ ê·¸ëŒ€ë¡œ -->
    <input
      type="text"
      name="prompt"
      placeholder="ì—¬í–‰ì§€ ì¡°ê±´ì„ ì…ë ¥í•´ë³´ì„¸ìš”!"
      value="{{ prompt }}"
    />
    <button type="submit" aria-label="ê²€ìƒ‰">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36"><path d="M23.707,22.293l-5.969-5.969a10.016,10.016,0,1,0-1.414,1.414l5.969,5.969a1,1,0,0,0,1.414-1.414ZM10,18a8,8,0,1,1,8-8A8.009,8.009,0,0,1,10,18Z"/></svg>
    </button>
  {% endif %}

  {# ì„ íƒëœ í•„í„° ìœ ì§€ #}
  {% if place_class %}<input type="hidden" name="place_class" value="{{ place_class }}">{% endif %}
  {% if match %}<input type="hidden" name="match" value="{{ match }}">{% endif %}
  {% for t in selected_tags %}
    <input type="hidden" name="tags" value="{{ t }}">
  {% endfor %}
</form>

{% if recommended_places and not show_followup %}
<h2 class="section-title">ì¶”ì²œ ì—¬í–‰ì§€</h2>

<!-- ì´ˆê¸° 3ê°œ ì¹´ë“œ (ê°€ë¡œ ë°°ì¹˜ ìœ ì§€) -->
<div class="recommend-grid">


  <ul class="place-list">
    {% for rec in recommended_places %}
    <li class="place-item">
      <div 
      id="map-{{ rec.place.id }}"
      class="place-item__map"
      data-lat="{{rec.place.lat}}"
      data-lng="{{rec.place.lng}}"
      ></div>
      <div class="place-item__head">
        <span class="place-item__name">{{ rec.place.name }}</span>
        <span class="place-item__meta">({{ rec.place.region }})</span>
      </div>
      <p class="place-card__summary">{{ rec.reason }}</p>
      {% if rec.tip %}
      <p class="place-card__tip"><span id="tip">Tip</span>{{ rec.tip }}</p>
      {% endif %}
      {% if not rec.reason and not rec.tip %} 
      <p class="place-card__summary">{{ rec.place.summary|truncatechars:200|default:"ì„¤ëª… ì—†ìŒ" }}</p>
      {% endif %}
      <div class="place-item__head">
        <a class="place-item__link" href="{% url 'places:place_detail' rec.place.pk %}">ìì„¸íˆ ë³´ê¸°</a>

        {% if user.is_authenticated %}
        <form method="post" action="{% url 'places:place_like' rec.place.pk %}" class="like-form">
          {% csrf_token %}
          <button type="submit" class="like-button">
            {% if place.is_liked %}â¤ï¸ ì°œì·¨ì†Œ{% else %}ğŸ¤ ì°œí•˜ê¸°{% endif %}
          </button>
        </form>

        <button type="button" class="add-to-route-btn" data-place-id="{{ rec.place.id }}">â• ë£¨íŠ¸ì— ì¶”ê°€</button>
        <div class="route-dropdown" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:.5rem; z-index:10; min-width:200px;">
          <div class="route-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          <hr>
          <div class="create-route-form">
            <input type="text" class="new-route-title" placeholder="ìƒˆ ë£¨íŠ¸ ì œëª©" style="width:90%; margin-bottom:.25rem;">
            <input type="text" class="new-route-summary" placeholder="ë£¨íŠ¸ ìš”ì•½(ì„ íƒ, 200ì ì´ë‚´)" style="width:90%; margin-bottom:.25rem;">
            <label class="custom-checkbox">
              <input type="checkbox" class="new-route-public" checked>
              <span>ê³µê°œ ë£¨íŠ¸ë¡œ ë§Œë“¤ê¸°</span> 
            </label>
            <button type="button" class="create-route-btn">ï¼‹ ìƒˆ ë£¨íŠ¸ ë§Œë“¤ê¸°</button>
          </div>
        </div>
        {% endif %}
      </div>
    </li>
    {% empty %}
      <li>í‘œì‹œí•  ì—¬í–‰ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
    {% endfor %}
  </ul>

</div>
{% endif %}
<a href="{% url 'places:main' %}" class="back-link">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

<script src="{% static 'js/map.js' %}?v={% now 'U' %}"></script>
<script
  src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}&v=weekly&loading=async&callback=initMap"
  async
  defer
></script>
<script src="{% static 'js/like.js' %}"></script>
<script src="{% static 'js/script.js' %}"></script>

{% endblock %}
