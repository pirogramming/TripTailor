{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<link rel="stylesheet" href="{% static 'css/tag.css' %}">
<form method="get" action="">
    <input
        type="text"
        name="prompt"
        placeholder="여행지 조건을 입력해보세요!"
        value="{{ prompt }}"
    />
    {% if show_followup %}
    <div>
        <strong>🤔 {{ question }}</strong>
        <input type="text" name="followup" placeholder="답변을 입력하세요" />
        <button type="submit">보충 답변 제출</button>
    </div>
    {% else %}
    <button type="submit">추천받기</button>
    {% endif %}
    <button type="submit">추천받기</button>
</form>

<section class="tag-rail" data-expanded="false">
  <div class="track" id="tagTrack"></div>
  <button type="button" class="chip more" aria-expanded="false">+ 더보기</button>
</section>

<style>
    .btn {
        display: inline-block;
        padding: 8px 16px;
        margin-right: 8px;
        background: #eee;
        color: #333;
        border-radius: 4px;
        text-decoration: none;
        border: 1px solid #ccc;
    }
    .btn.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
    }
</style>

<div class="filter-bar">
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}"
     class="btn {% if not place_class %}active{% endif %}">전체</a>
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}place_class=1"
     class="btn {% if place_class == '1' %}active{% endif %}">레포츠</a>
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}place_class=2"
     class="btn {% if place_class == '2' %}active{% endif %}">쇼핑</a>
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}place_class=3"
     class="btn {% if place_class == '3' %}active{% endif %}">관광지</a>
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}place_class=4"
     class="btn {% if place_class == '4' %}active{% endif %}">문화시설</a>
</div>

<h2 class="place-section__title">전체 여행지</h2>
<ul class="place-list">
  {% for place in places %}
  <li class="place-item">
    <div class="place-item__head">
      <span class="place-item__name">{{ place.name }}</span>
      <span class="place-item__meta">({{ place.region }}) ·
        {% if place.place_class == 1 %}레포츠{% elif place.place_class == 2 %}쇼핑{% elif place.place_class == 3 %}관광지{% elif place.place_class == 4 %}문화시설{% endif %}
      </span>
      <a class="place-item__link" href="{% url 'places:place_detail' place.pk %}">자세히 보기</a>
      {% if user.is_authenticated %}
      <form method="post" action="{% url 'places:place_like' place.pk %}" class="like-form">
        {% csrf_token %}
        <button type="submit" class="like-button">
          {% if place.is_liked %}❤️ 취소{% else %}🤍 좋아요{% endif %}
        </button>
      </form>
      <button type="button" class="add-to-route-btn" data-place-id="{{ place.id }}">
                ➕ 루트에 추가
            </button>

            <!-- 드롭다운 -->
            <div class="route-dropdown" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:.5rem; z-index:10; min-width:200px;">
                <div class="route-list">불러오는 중...</div>
                <hr>
                <div class="create-route-form">
                    <input type="text" class="new-route-title" placeholder="새 루트 제목" style="width:100%; margin-bottom:.25rem;">
                    <input type="text" class="new-route-summary" placeholder="루트 요약(선택, 200자 이내)" style="width:100%; margin-bottom:.25rem;">
                    <button type="button" class="create-route-btn">＋ 새 루트 만들기</button>
                </div>
            </div>
      {% endif %}
    </div>

    <ul class="tag-list">
      {% for tag in place.tags.all %}
      <li class="tag">#{{ tag.name }}</li>
      {% endfor %}
    </ul>
  </li>
  {% endfor %}
</ul>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');

// 버튼 클릭 시 드롭다운 표시 + 목록 불러오기
document.querySelectorAll('.add-to-route-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const dropdown = btn.nextElementSibling;
    const placeId = btn.dataset.placeId;

    // 다른 드롭다운 닫기
    document.querySelectorAll('.route-dropdown').forEach(d => {
      if (d !== dropdown) d.style.display = 'none';
    });

    // 토글
    dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
    if (dropdown.style.display === 'block') {
      const listBox = dropdown.querySelector('.route-list');
      listBox.textContent = '불러오는 중...';
      try {
        const res = await fetch("{% url 'routes:my_routes_json' %}", { credentials: 'same-origin' });
        const data = await res.json();
        if (!data.routes.length) {
          listBox.innerHTML = '<p>루트 없음</p>';
        } else {
          listBox.innerHTML = data.routes.map(r => `
            <div>
              <button type="button" class="select-route-btn" data-route-id="${r.id}" data-place-id="${placeId}">
                ${r.title}
              </button>
            </div>
          `).join('');
        }
      } catch (err) {
        listBox.textContent = '불러오기 실패';
      }
    }
  });
});

// 루트 선택 → 장소 추가
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('select-route-btn')) {
    const routeId = e.target.dataset.routeId;
    const placeId = e.target.dataset.placeId;
    const endpoint = `{% url 'routes:add_place' 0 0 %}`.replace('/0/add/0/', `/${routeId}/add/${placeId}/`);

    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
        credentials: 'same-origin'
      });
      const data = await res.json();
      alert(data.duplicated ? '이미 해당 루트에 있음' : '루트에 추가됨');
    } catch (err) {
      alert('추가 실패');
    }
  }
});

// 새 루트 생성 → 목록 갱신
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('create-route-btn')) {
    const dropdown = e.target.closest('.route-dropdown');
    const titleInput = dropdown.querySelector('.new-route-title');
    const summaryInput = dropdown.querySelector('.new-route-summary');

    const title = titleInput.value.trim();
    const summary = (summaryInput?.value || '').trim();
    if (!title) {
      alert('제목을 입력하세요');
      return;
    }
    try {
      const fd = new FormData();
      fd.append('title', title);
      fd.append('location_summary', summary);

      const res = await fetch("{% url 'routes:create_route' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
        body: fd,
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (data.ok) {
        alert('루트 생성됨');
        titleInput.value = '';
        if (summaryInput) summaryInput.value = '';
        const listBox = dropdown.querySelector('.route-list');
        const placeId = dropdown.previousElementSibling.dataset.placeId;
        const btnHtml = `<div><button type="button" class="select-route-btn" data-route-id="${data.route.id}" data-place-id="${placeId}">${data.route.title}</button></div>`;
        listBox.insertAdjacentHTML('afterbegin', btnHtml);
      } else {
        alert('생성 실패');
      }
    } catch (err) {
      alert('오류 발생');
    }
  }
});

(async function () {
  const res = await fetch("{% url 'places:tags_json' %}");
  const tags = await res.json();

  const initialCount = 5;
  const rail = document.querySelector('.tag-rail');
  const track = document.getElementById('tagTrack');
  const moreBtn = rail.querySelector('.chip.more');

  // 현재 URL에서 선택된 태그 복원
  const params = new URLSearchParams(location.search);
  const preselected = (params.get('tags') || "")
                        .split(',').filter(Boolean);

  // 칩 렌더
  tags.forEach((t, i) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chip' + (i >= initialCount ? ' extra' : '');
    btn.dataset.tag = t.name;
    btn.textContent = `#${t.name}`;
    if (preselected.includes(t.name)) {
      btn.classList.add('active');
      btn.setAttribute('aria-pressed', 'true');
    } else {
      btn.setAttribute('aria-pressed', 'false');
    }
    track.appendChild(btn);
  });

  // 더보기/접기
  moreBtn.addEventListener('click', () => {
    const expanded = rail.dataset.expanded === 'true';
    rail.dataset.expanded = (!expanded).toString();
    moreBtn.textContent = expanded ? '+ 더보기' : '접기';
    moreBtn.setAttribute('aria-expanded', (!expanded).toString());
  });
  if (tags.length <= initialCount) moreBtn.style.display = 'none';

  // ✅ 칩 클릭 → URL 파라미터 갱신 → 즉시 새로고침
  track.addEventListener('click', (e) => {
    const chip = e.target.closest('.chip');
    if (!chip || chip.classList.contains('more')) return;

    // --- 다중 선택(OR 매칭) ---
    chip.classList.toggle('active');
    chip.setAttribute('aria-pressed', chip.classList.contains('active') ? 'true' : 'false');

    const selected = [...track.querySelectorAll('.chip.active')].map(b => b.dataset.tag);

    const url = new URL(window.location.href);
    if (selected.length) {
      url.searchParams.set('tags', selected.join(','));  // 예: tags=a,b,c
      url.searchParams.set('match', 'any');              // OR 매칭 (원하면 'all')
    } else {
      url.searchParams.delete('tags');
      url.searchParams.delete('match');
    }

    // 다른 파라미터들(prompt, followup, place_class 등)은 그대로 유지됨
    window.location.assign(url.toString());
  });

})();

document.querySelectorAll('.btn.cat').forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    const url = new URL(window.location.href);
    const cls = a.dataset.class;

    if (cls) url.searchParams.set('place_class', cls);
    else url.searchParams.delete('place_class'); // 전체

    // 기존 파라미터(prompt, followup, tags, match)는 그대로 보존됨
    window.location.assign(url.toString());
  });
});

</script>
{% endblock %}

