{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">

<form method="get" action="">
    <input
        type="text"
        name="prompt"
        placeholder="ì—¬í–‰ì§€ ì¡°ê±´ì„ ì…ë ¥í•´ë³´ì„¸ìš”!"
        value="{{ prompt }}"
    />
    {% if show_followup %}
    <div>
        <strong>ğŸ¤” {{ question }}</strong>
        <input type="text" name="followup" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <button type="submit">ë³´ì¶© ë‹µë³€ ì œì¶œ</button>
    </div>
    {% else %}
    <button type="submit">ì¶”ì²œë°›ê¸°</button>
    {% endif %}
</form>

<!-- ì¶”ì²œ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
{% if recommended_places and not show_followup %}
<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
    <h3>ğŸ¯ ì¶”ì²œ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 15px;">
        {% for rec in recommended_places|slice:":3" %}
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4>{{ rec.place.name }}</h4>
            <p>ğŸ“ {{ rec.place.region }}</p>
            <p>{{ rec.place.summary|default:"ì„¤ëª… ì—†ìŒ"|truncatechars:80 }}</p>
            <div style="margin: 10px 0;">
                {% for tag in rec.place.tags.all|slice:":3" %}
                <span style="background: #e9ecef; padding: 2px 6px; border-radius: 10px; font-size: 12px; margin-right: 5px;">#{{ tag.name }}</span>
                {% endfor %}
            </div>
            <a href="{% url 'places:place_detail' rec.place.pk %}" style="color: #007bff; text-decoration: none;">ìì„¸íˆ ë³´ê¸°</a>
        </div>
        {% endfor %}
    </div>
    <div style="text-align: center;">
        <a href="{% url 'places:search' %}?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}" 
           style="background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
            ğŸ” ë” ë§ì€ ì¶”ì²œ ê²°ê³¼ ë³´ê¸° â†’
        </a>
    </div>
</div>
{% endif %}

<!-- ëŒ€ë¶„ë¥˜ í´ë¦­ ë²„íŠ¼ -->
<div style="margin: 16px 0">
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}"
        class="btn {% if not place_class %}active{% endif %}"
        >ì „ì²´</a
    >
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}place_class=1"
        class="btn {% if place_class == '1' %}active{% endif %}"
        >ë ˆí¬ì¸ </a
    >
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}place_class=2"
        class="btn {% if place_class == '2' %}active{% endif %}"
        >ì‡¼í•‘</a
    >
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}place_class=3"
        class="btn {% if place_class == '3' %}active{% endif %}"
        >ê´€ê´‘ì§€</a
    >
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}place_class=4"
        class="btn {% if place_class == '4' %}active{% endif %}"
        >ë¬¸í™”ì‹œì„¤</a
    >
</div>

<style>
    .btn {
        display: inline-block;
        padding: 8px 16px;
        margin-right: 8px;
        background: #eee;
        color: #333;
        border-radius: 4px;
        text-decoration: none;
        border: 1px solid #ccc;
    }
    .btn.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
    }
</style>

<h2>ì „ì²´ ì—¬í–‰ì§€ ({{ places.paginator.count }}ê°œ)</h2>
<ul>
    {% for place in places %}
    <li>
        <strong>{{ place.name }}</strong> ({{ place.region }}) - 
        {% if place.place_class == 1 %}ë ˆí¬ì¸ {% elif place.place_class == 2 %}ì‡¼í•‘{% elif place.place_class == 3 %}ê´€ê´‘ì§€{% elif place.place_class == 4 %}ë¬¸í™”ì‹œì„¤{% endif %}
        <a href="{% url 'places:place_detail' place.pk %}">ìì„¸íˆ ë³´ê¸°</a>
        {% if user.is_authenticated %}
            <form method="post" action="{% url 'places:place_like' place.pk %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" style="background: none; border: none; cursor: pointer;">
                    {% if place.is_liked %}
                        â¤ï¸ {{ place.like_count }}
                    {% else %}
                        ğŸ¤ {{ place.like_count }}
                    {% endif %}
                </button>
            </form>
        {% else %}
            <span>ğŸ¤ {{ place.like_count }}</span>
        {% endif %}
        <ul>
            {% for tag in place.tags.all %}
            <li>#{{ tag.name }}</li>
            {% endfor %}
        </ul>
    </li>
    {% endfor %}
</ul>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
{% if places.has_other_pages %}
<div style="text-align: center; margin: 20px 0;">
    <div style="margin-bottom: 10px;">
        {{ places.number }} / {{ places.paginator.num_pages }} í˜ì´ì§€
    </div>
    
    <div>
        {% if places.has_previous %}
        <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}{% if place_class %}place_class={{ place_class }}&{% endif %}page={{ places.previous_page_number }}" 
           style="padding: 8px 12px; margin: 0 5px; background: #f8f9fa; color: #007bff; text-decoration: none; border-radius: 4px;">â† ì´ì „</a>
        {% endif %}
        
        {% for page_num in places.paginator.page_range %}
            {% if page_num == places.number %}
            <span style="padding: 8px 12px; margin: 0 5px; background: #007bff; color: white; border-radius: 4px;">{{ page_num }}</span>
            {% elif page_num > places.number|add:'-3' and page_num < places.number|add:'3' %}
            <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}{% if place_class %}place_class={{ place_class }}&{% endif %}page={{ page_num }}" 
               style="padding: 8px 12px; margin: 0 5px; background: #f8f9fa; color: #007bff; text-decoration: none; border-radius: 4px;">{{ page_num }}</a>
            {% endif %}
        {% endfor %}
        
        {% if places.has_next %}
        <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}{% if place_class %}place_class={{ place_class }}&{% endif %}page={{ places.next_page_number }}" 
           style="padding: 8px 12px; margin: 0 5px; background: #f8f9fa; color: #007bff; text-decoration: none; border-radius: 4px;">ë‹¤ìŒ â†’</a>
        {% endif %}
    </div>
</div>
{% endif %}

{% endblock %}