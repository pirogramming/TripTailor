{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">

<form method="get" action="">
    <input
        type="text"
        name="prompt"
        placeholder="여행지 조건을 입력해보세요!"
        value="{{ prompt }}"
    />
    {% if show_followup %}
    <div>
        <strong>🤔 {{ question }}</strong>
        <input type="text" name="followup" placeholder="답변을 입력하세요" />
        <button type="submit">보충 답변 제출</button>
    </div>
    {% else %}
    <button type="submit">추천받기</button>
    {% endif %}
</form>

<!-- 추천 결과 미리보기 -->
{% if recommended_places and not show_followup %}
<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
    <h3>🎯 추천 결과 미리보기</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 15px;">
        {% for rec in recommended_places|slice:":3" %}
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4>{{ rec.place.name }}</h4>
            <p>📍 {{ rec.place.region }}</p>
            <p>{{ rec.place.summary|default:"설명 없음"|truncatechars:80 }}</p>
            <div style="margin: 10px 0;">
                {% for tag in rec.place.tags.all|slice:":3" %}
                <span style="background: #e9ecef; padding: 2px 6px; border-radius: 10px; font-size: 12px; margin-right: 5px;">#{{ tag.name }}</span>
                {% endfor %}
            </div>
            <a href="{% url 'places:place_detail' rec.place.pk %}" style="color: #007bff; text-decoration: none;">자세히 보기</a>
        </div>
        {% endfor %}
    </div>
    <div style="text-align: center;">
        <a href="{% url 'places:search' %}?prompt={{ prompt|urlencode }}{% if followup %}&followup={{ followup|urlencode }}{% endif %}" 
           style="background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
            🔍 더 많은 추천 결과 보기 →
        </a>
    </div>
</div>
{% endif %}

<!-- 대분류 클릭 버튼 -->
<div style="margin: 16px 0">
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}"
        class="btn {% if not place_class %}active{% endif %}"
        >전체</a
    >
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}place_class=1"
        class="btn {% if place_class == '1' %}active{% endif %}"
        >레포츠</a
    >
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}place_class=2"
        class="btn {% if place_class == '2' %}active{% endif %}"
        >쇼핑</a
    >
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}place_class=3"
        class="btn {% if place_class == '3' %}active{% endif %}"
        >관광지</a
    >
    <a
        href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}place_class=4"
        class="btn {% if place_class == '4' %}active{% endif %}"
        >문화시설</a
    >
</div>

<style>
    .btn {
        display: inline-block;
        padding: 8px 16px;
        margin-right: 8px;
        background: #eee;
        color: #333;
        border-radius: 4px;
        text-decoration: none;
        border: 1px solid #ccc;
    }
    .btn.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
    }
</style>

<h2>전체 여행지 ({{ places.paginator.count }}개)</h2>
<ul>
    {% for place in places %}
    <li>
        <strong>{{ place.name }}</strong> ({{ place.region }}) - 
        {% if place.place_class == 1 %}레포츠{% elif place.place_class == 2 %}쇼핑{% elif place.place_class == 3 %}관광지{% elif place.place_class == 4 %}문화시설{% endif %}
        <a href="{% url 'places:place_detail' place.pk %}">자세히 보기</a>
        {% if user.is_authenticated %}
            <form method="post" action="{% url 'places:place_like' place.pk %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" style="background: none; border: none; cursor: pointer;">
                    {% if place.is_liked %}
                        ❤️ {{ place.like_count }}
                    {% else %}
                        🤍 {{ place.like_count }}
                    {% endif %}
                </button>
            </form>
        {% else %}
            <span>🤍 {{ place.like_count }}</span>
        {% endif %}
        <ul>
            {% for tag in place.tags.all %}
            <li>#{{ tag.name }}</li>
            {% endfor %}
        </ul>
    </li>
    {% endfor %}
</ul>

<!-- 페이지네이션 -->
{% if places.has_other_pages %}
<div style="text-align: center; margin: 20px 0;">
    <div style="margin-bottom: 10px;">
        {{ places.number }} / {{ places.paginator.num_pages }} 페이지
    </div>
    
    <div>
        {% if places.has_previous %}
        <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}{% if place_class %}place_class={{ place_class }}&{% endif %}page={{ places.previous_page_number }}" 
           style="padding: 8px 12px; margin: 0 5px; background: #f8f9fa; color: #007bff; text-decoration: none; border-radius: 4px;">← 이전</a>
        {% endif %}
        
        {% for page_num in places.paginator.page_range %}
            {% if page_num == places.number %}
            <span style="padding: 8px 12px; margin: 0 5px; background: #007bff; color: white; border-radius: 4px;">{{ page_num }}</span>
            {% elif page_num > places.number|add:'-3' and page_num < places.number|add:'3' %}
            <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}{% if place_class %}place_class={{ place_class }}&{% endif %}page={{ page_num }}" 
               style="padding: 8px 12px; margin: 0 5px; background: #f8f9fa; color: #007bff; text-decoration: none; border-radius: 4px;">{{ page_num }}</a>
            {% endif %}
        {% endfor %}
        
        {% if places.has_next %}
        <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}{% if followup %}followup={{ followup }}&{% endif %}{% if place_class %}place_class={{ place_class }}&{% endif %}page={{ places.next_page_number }}" 
           style="padding: 8px 12px; margin: 0 5px; background: #f8f9fa; color: #007bff; text-decoration: none; border-radius: 4px;">다음 →</a>
        {% endif %}
    </div>
</div>
{% endif %}

{% endblock %}