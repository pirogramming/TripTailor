{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<link rel="stylesheet" href="{% static 'css/tag.css' %}">
<form method="get" action="">
    <input
        type="text"
        name="prompt"
        placeholder="ì—¬í–‰ì§€ ì¡°ê±´ì„ ì…ë ¥í•´ë³´ì„¸ìš”!"
        value="{{ prompt }}"
    />
    {% if show_followup %}
    <div>
        <strong>ğŸ¤” {{ question }}</strong>
        <input type="text" name="followup" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <button type="submit">ë³´ì¶© ë‹µë³€ ì œì¶œ</button>
    </div>
    {% else %}
    <button type="submit">ì¶”ì²œë°›ê¸°</button>
    {% endif %}
</form>

<section class="tag-rail" data-expanded="false">
  <div class="track" id="tagTrack">
    {% for t in tags %}
      <button
        type="button"
        class="chip{% if t.name in selected_tags %} active{% endif %}{% if forloop.counter0 >= 5 %} extra{% endif %}"
        data-tag="{{ t.name }}"
        aria-pressed="{% if t.name in selected_tags %}true{% else %}false{% endif %}">
        #{{ t.name }}
      </button>
    {% endfor %}
  </div>
  <button type="button" class="chip more" aria-expanded="false">+ ë”ë³´ê¸°</button>
</section>

<style>
    .btn {
        display: inline-block;
        padding: 8px 16px;
        margin-right: 8px;
        background: #eee;
        color: #333;
        border-radius: 4px;
        text-decoration: none;
        border: 1px solid #ccc;
    }
    .btn.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
    }
</style>
<div class="filter-bar">
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}"
     class="btn {% if not place_class %}active{% endif %}">ì „ì²´</a>
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}place_class=1"
     class="btn {% if place_class == '1' %}active{% endif %}">ë ˆí¬ì¸ </a>
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}place_class=2"
     class="btn {% if place_class == '2' %}active{% endif %}">ì‡¼í•‘</a>
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}place_class=3"
     class="btn {% if place_class == '3' %}active{% endif %}">ê´€ê´‘ì§€</a>
  <a href="?{% if prompt %}prompt={{ prompt }}&{% endif %}place_class=4"
     class="btn {% if place_class == '4' %}active{% endif %}">ë¬¸í™”ì‹œì„¤</a>
</div>
<h2 class="place-section__title">ì „ì²´ ì—¬í–‰ì§€</h2>
<ul class="place-list">
  {% for place in places %}
  <li class="place-item">
    <div class="place-item__head">
      <span class="place-item__name">{{ place.name }}</span>
      <span class="place-item__meta">({{ place.region }}) Â·
        {% if place.place_class == 1 %}ë ˆí¬ì¸ {% elif place.place_class == 2 %}ì‡¼í•‘{% elif place.place_class == 3 %}ê´€ê´‘ì§€{% elif place.place_class == 4 %}ë¬¸í™”ì‹œì„¤{% endif %}
      </span>
      <a class="place-item__link" href="{% url 'places:place_detail' place.pk %}">ìì„¸íˆ ë³´ê¸°</a>
      {% if user.is_authenticated %}
      <form method="post" action="{% url 'places:place_like' place.pk %}" class="like-form">
        {% csrf_token %}
        <button type="submit" class="like-button">
          {% if place.is_liked %}â¤ï¸ ì·¨ì†Œ{% else %}ğŸ¤ ì¢‹ì•„ìš”{% endif %}
        </button>
      </form>
      <button type="button" class="add-to-route-btn" data-place-id="{{ place.id }}">
                â• ë£¨íŠ¸ì— ì¶”ê°€
            </button>
            <!-- ë“œë¡­ë‹¤ìš´ -->
            <div class="route-dropdown" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:.5rem; z-index:10; min-width:200px;">
                <div class="route-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                <hr>
                <div class="create-route-form">
                    <input type="text" class="new-route-title" placeholder="ìƒˆ ë£¨íŠ¸ ì œëª©" style="width:100%; margin-bottom:.25rem;">
                    <input type="text" class="new-route-summary" placeholder="ë£¨íŠ¸ ìš”ì•½(ì„ íƒ, 200ì ì´ë‚´)" style="width:100%; margin-bottom:.25rem;">
                    <button type="button" class="create-route-btn">ï¼‹ ìƒˆ ë£¨íŠ¸ ë§Œë“¤ê¸°</button>
                </div>
            </div>
      {% endif %}
    </div>
    <ul class="tag-list">
      {% for tag in place.tags.all %}
      <li class="tag">#{{ tag.name }}</li>
      {% endfor %}
    </ul>
  </li>
  {% endfor %}
</ul>
{% comment %} <script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');
/* =========================
   íƒœê·¸: ë”ë³´ê¸°/ì ‘ê¸° & Ajax í•„í„°
   ========================= */
const rail = document.querySelector('.tag-rail');
const track = document.getElementById('tagTrack');
const moreBtn = rail.querySelector('.chip.more');

/* ë”ë³´ê¸°/ì ‘ê¸° ì´ˆê¸°í™” */
(function initMore(){
  const hidden = track.querySelectorAll('.chip.extra').length;
  if (!hidden) moreBtn.style.display = 'none';
  moreBtn.addEventListener('click', () => {
    const expanded = rail.dataset.expanded === 'true';
    rail.dataset.expanded = (!expanded).toString();
    moreBtn.textContent = expanded ? '+ ë”ë³´ê¸°' : 'ì ‘ê¸°';
    moreBtn.setAttribute('aria-expanded', (!expanded).toString());
  });
})();

/* í˜„ì¬ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ GETí•´ì„œ .place-listë§Œ êµì²´ (ëŒ€ë¶„ë¥˜ ë“± ê¸°ì¡´ íŒŒë¼ë¯¸í„° ê·¸ëŒ€ë¡œ ìœ ì§€) */
async function fetchAndSwapList(nextParams) {
  const url = new URL(window.location.href);

  // ê¸°ì¡´ ì¿¼ë¦¬ ì´ˆê¸°í™”
  for (const k of Array.from(url.searchParams.keys())) url.searchParams.delete(k);
  // ìƒˆ íŒŒë¼ë¯¸í„° ì±„ìš°ê¸°
  nextParams.forEach((v, k) => url.searchParams.set(k, v));

  // ë¡œë”© í‘œì‹œ (ì„ íƒ)
  const listEl = document.querySelector('.place-list');
  if (listEl) listEl.insertAdjacentHTML('beforebegin', '<div id="list-loading" style="padding:1rem">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>');

  try {
    const res = await fetch(url.toString(), { credentials: 'same-origin' });
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');

    const fetchedList = doc.querySelector('.place-list');
    const currentList = document.querySelector('.place-list');

    if (fetchedList && currentList) {
      currentList.outerHTML = fetchedList.outerHTML; // ë¦¬ìŠ¤íŠ¸ë§Œ êµì²´
    }

    // ì£¼ì†Œì°½ ê°±ì‹  (ë’¤ë¡œê°€ê¸° ì§€ì›)
    history.pushState(null, '', url.toString());
  } finally {
    const ld = document.getElementById('list-loading');
    if (ld) ld.remove();
  }
}

/* ì¹© í´ë¦­ â†’ URL íŒŒë¼ë¯¸í„° ê°±ì‹  â†’ Ajaxë¡œ ëª©ë¡ë§Œ ê°±ì‹  */
track.addEventListener('click', async (e) => {
  const chip = e.target.closest('.chip');
  if (!chip || chip.classList.contains('more')) return;

  chip.classList.toggle('active');
  chip.setAttribute('aria-pressed', chip.classList.contains('active') ? 'true' : 'false');

  const selected = [...track.querySelectorAll('.chip.active')].map(b => b.dataset.tag);

  // í˜„ URL ê¸°ë°˜ìœ¼ë¡œ ìƒˆ íŒŒë¼ë¯¸í„° ìƒì„± (ëŒ€ë¶„ë¥˜ place_class, prompt ë“± ê¸°ì¡´ íŒŒë¼ë¯¸í„° ìœ ì§€)
  const next = new URLSearchParams(window.location.search);
  if (selected.length) {
    next.set('tags', selected.join(','));
  } else {
    next.delete('tags');
  }

  await fetchAndSwapList(next);
});

/* ===========================================
   ë£¨íŠ¸: 'ì¶”ê°€' ë²„íŠ¼ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ì—´ê³  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
   (ìœ„ì„ ë°©ì‹ì´ë¼ Ajax ë’¤ì—ë„ ê³„ì† ë™ì‘)
   =========================================== */
document.addEventListener('click', async (e) => {
  // ë“œë¡­ë‹¤ìš´ ì—´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°
  const addBtn = e.target.closest('.add-to-route-btn');
  if (addBtn) {
    const dropdown = addBtn.nextElementSibling;
    const placeId = addBtn.dataset.placeId;

    // ë‹¤ë¥¸ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.querySelectorAll('.route-dropdown').forEach(d => {
      if (d !== dropdown) d.style.display = 'none';
    });

    // í† ê¸€
    dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';

    if (dropdown.style.display === 'block') {
      const listBox = dropdown.querySelector('.route-list');
      listBox.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      try {
        const res = await fetch("{% url 'routes:my_routes_json' %}", { credentials: 'same-origin' });
        const data = await res.json();
        if (!data.routes.length) {
          listBox.innerHTML = '<p>ë£¨íŠ¸ ì—†ìŒ</p>';
        } else {
          listBox.innerHTML = data.routes.map(r => `
            <div>
              <button type="button" class="select-route-btn" data-route-id="${r.id}" data-place-id="${placeId}">
                ${r.title}
              </button>
            </div>
          `).join('');
        }
      } catch (err) {
        listBox.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
      }
    }
  }
});

// ë£¨íŠ¸ ì„ íƒ â†’ ì¥ì†Œ ì¶”ê°€
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('select-route-btn')) {
    const routeId = e.target.dataset.routeId;
    const placeId = e.target.dataset.placeId;
    const endpoint = `{% url 'routes:add_place' 0 0 %}`.replace('/0/add/0/', `/${routeId}/add/${placeId}/`);
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
        credentials: 'same-origin'
      });
      const data = await res.json();
      alert(data.duplicated ? 'ì´ë¯¸ í•´ë‹¹ ë£¨íŠ¸ì— ìˆìŒ' : 'ë£¨íŠ¸ì— ì¶”ê°€ë¨');
    } catch (err) {
      alert('ì¶”ê°€ ì‹¤íŒ¨');
    }
  }
});
// ìƒˆ ë£¨íŠ¸ ìƒì„± â†’ ëª©ë¡ ê°±ì‹ 
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('create-route-btn')) {
    const dropdown = e.target.closest('.route-dropdown');
    const titleInput = dropdown.querySelector('.new-route-title');
    const summaryInput = dropdown.querySelector('.new-route-summary');
    const title = titleInput.value.trim();
    const summary = (summaryInput?.value || '').trim();
    if (!title) {
      alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }
    try {
      const fd = new FormData();
      fd.append('title', title);
      fd.append('location_summary', summary);
      const res = await fetch("{% url 'routes:create_route' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
        body: fd,
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (data.ok) {
        alert('ë£¨íŠ¸ ìƒì„±ë¨');
        titleInput.value = '';
        if (summaryInput) summaryInput.value = '';
        const listBox = dropdown.querySelector('.route-list');
        const placeId = dropdown.previousElementSibling.dataset.placeId;
        const btnHtml = `<div><button type="button" class="select-route-btn" data-route-id="${data.route.id}" data-place-id="${placeId}">${data.route.title}</button></div>`;
        listBox.insertAdjacentHTML('afterbegin', btnHtml);
      } else {
        alert('ìƒì„± ì‹¤íŒ¨');
      }
    } catch (err) {
      alert('ì˜¤ë¥˜ ë°œìƒ');
    }
  }
});

window.addEventListener('popstate', async () => {
  const next = new URLSearchParams(window.location.search);
  await fetchAndSwapList(next);
  // íƒœê·¸ ì¹© UI ìƒíƒœë„ URLì— ë§ì¶° ë™ê¸°í™”
  const selected = (next.get('tags') || '').split(',').filter(Boolean);
  document.querySelectorAll('#tagTrack .chip').forEach(chip => {
    const on = selected.includes(chip.dataset.tag);
    chip.classList.toggle('active', on);
    chip.setAttribute('aria-pressed', on ? 'true' : 'false');
  });
});

</script> {% endcomment %}
{% endblock %}
