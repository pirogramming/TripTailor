{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/main.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="{% static 'css/tag.css' %}?v={% now 'U' %}">

<h1 class="search-title">Trip Tailor</h1>
<form method="get" action="">
  <input
    type="text"
    name="q"
    placeholder="ê²€ìƒ‰ì°½ì— ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”!"
    value="{{ query }}"
  />
  <button type="submit" aria-label="ê²€ìƒ‰">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36"><path d="M23.707,22.293l-5.969-5.969a10.016,10.016,0,1,0-1.414,1.414l5.969,5.969a1,1,0,0,0,1.414-1.414ZM10,18a8,8,0,1,1,8-8A8.009,8.009,0,0,1,10,18Z"/></svg>
  </button>

  {% if place_class %}<input type="hidden" name="place_class" value="{{ place_class }}">{% endif %}
  {% if match %}<input type="hidden" name="match" value="{{ match }}">{% endif %}
  {% for t in selected_tags %}
    <input type="hidden" name="tags" value="{{ t }}">
  {% endfor %}
</form>

<section class="tag-rail" data-expanded="false">
  <div class="track" id="tagTrack">
    {% for t in tags %}
      <button
        type="button"
        class="chip{% if t.name in selected_tags %} active{% endif %}{% if forloop.counter0 >= 5 %} extra{% endif %}"
        data-tag="{{ t.name }}"
        aria-pressed="{% if t.name in selected_tags %}true{% else %}false{% endif %}">
        #{{ t.name }}
      </button>
    {% endfor %}
  </div>
  <button type="button" class="chip more" aria-expanded="false">+ ë”ë³´ê¸°</button>
</section>

<div class="filter-bar">
  <form id="filterForm">
    <label>
      <input type="radio" name="place_class" value="" {% if not place_class %}checked{% endif %}>
      <span class="text">ì „ì²´</span>
    </label>
    <label>
      <input type="radio" name="place_class" value="1" {% if place_class == '1' %}checked{% endif %}>
      <span class="text">ë ˆí¬ì¸ </span>
    </label>
    <label>
      <input type="radio" name="place_class" value="2" {% if place_class == '2' %}checked{% endif %}>
      <span class="text">ì‡¼í•‘</span>
    </label>
    <label>
      <input type="radio" name="place_class" value="3" {% if place_class == '3' %}checked{% endif %}>
      <span class="text">ê´€ê´‘ì§€</span>
    </label>
    <label>
      <input type="radio" name="place_class" value="4" {% if place_class == '4' %}checked{% endif %}>
      <span class="text">ë¬¸í™”ì‹œì„¤</span>
    </label>

    {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}
    {% if match %}<input type="hidden" name="match" value="{{ match }}">{% endif %}
    {% if is_unique %}<input type="hidden" name="is_unique" value="{{ is_unique }}">{% endif %}
    {% for t in selected_tags %}
      <input type="hidden" name="tags" value="{{ t }}">
    {% endfor %}
  </form>
</div>

<div class="unique-filter-bar">
  <form id="uniqueFilterForm">
    <label class="unique-filter-label">
      <input type="checkbox" name="is_unique" value="1" {% if is_unique == '1' %}checked{% endif %}>
      <span class="unique-filter-text">ì´ìƒ‰ì </span>
    </label>

    {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}
    {% if place_class %}<input type="hidden" name="place_class" value="{{ place_class }}">{% endif %}
    {% if match %}<input type="hidden" name="match" value="{{ match }}">{% endif %}
    {% for t in selected_tags %}
      <input type="hidden" name="tags" value="{{ t }}">
    {% endfor %}
  </form>
</div>

{% if query %}
<h2 class="place-section__title">"{{ query }}" ê²€ìƒ‰ ê²°ê³¼</h2>
{% else %}
<h2 class="place-section__title">ì „ì²´ ì—¬í–‰ì§€</h2>
{% endif %}

<div id="results">
  <ul class="place-list">
    {% for place in places %}
    <li class="place-item">
      <div 
      id="map-{{ place.id }}"
      class="place-item__map"
      data-lat="{{place.lat}}"
      data-lng="{{place.lng}}"
      ></div>
      <div class="place-item__head">
        <span class="place-item__name">{{ place.name }}</span>
        <span class="place-item__meta">({{ place.region }}) Â·
          {% if place.place_class == 1 %}ë ˆí¬ì¸ {% elif place.place_class == 2 %}ì‡¼í•‘{% elif place.place_class == 3 %}ê´€ê´‘ì§€{% elif place.place_class == 4 %}ë¬¸í™”ì‹œì„¤{% endif %}
        </span>
        <a class="place-item__link" href="{% url 'places:place_detail' place.pk %}">ìì„¸íˆ ë³´ê¸°</a>

        {% if user.is_authenticated %}
        <form method="post" action="{% url 'places:place_like' place.pk %}" class="like-form">
          {% csrf_token %}
          <button type="submit" class="like-button">
            {% if place.is_liked %}â¤ï¸ ì°œì·¨ì†Œ{% else %}ğŸ¤ ì°œí•˜ê¸°{% endif %}
          </button>
        </form>

        <button type="button" class="add-to-route-btn" data-place-id="{{ place.id }}">â• ë£¨íŠ¸ì— ì¶”ê°€</button>
        <div class="route-dropdown" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:.5rem; z-index:10; min-width:200px;">
          <div class="route-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          <hr>
          <div class="create-route-form">
            <input type="text" class="new-route-title" placeholder="ìƒˆ ë£¨íŠ¸ ì œëª©" style="width:100%; margin-bottom:.25rem;">
            <input type="text" class="new-route-summary" placeholder="ë£¨íŠ¸ ìš”ì•½(ì„ íƒ, 200ì ì´ë‚´)" style="width:100%; margin-bottom:.25rem;">
            <label class="custom-checkbox">
              <input type="checkbox" class="new-route-public" checked>
              <span>ê³µê°œ ë£¨íŠ¸ë¡œ ë§Œë“¤ê¸°</span> 
            </label>
            <button type="button" class="create-route-btn">ï¼‹ ìƒˆ ë£¨íŠ¸ ë§Œë“¤ê¸°</button>
          </div>
        </div>
        {% endif %}
      </div>
      <ul class="tag-list">
        {% for tag in place.tags.all %}
          <li class="tag">#{{ tag.name }}</li>
        {% endfor %}
      </ul>
    </li>
    {% empty %}
      {% if query %}
        <li>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      {% else %}
        <li>í‘œì‹œí•  ì—¬í–‰ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      {% endif %}
    {% endfor %}
  </ul>

  {% if places.paginator.num_pages > 1 %}
  <div class="pagination">
    {% if places.has_previous %}
      <a href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ places.previous_page_number }}">ì´ì „</a>
    {% endif %}

    {% if show_first %}
      <a href="?{{ base_qs }}{% if base_qs %}&{% endif %}page=1">1</a>
    {% endif %}
    {% if show_first_ellipsis %}<span>â€¦</span>{% endif %}

    {% for num in page_window %}
      {% if num == places.number %}
        <span class="current">{{ num }}</span>
      {% else %}
        <a href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ num }}">{{ num }}</a>
      {% endif %}
    {% endfor %}

    {% if show_last_ellipsis %}<span>â€¦</span>{% endif %}
    {% if show_last %}
      <a href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ places.paginator.num_pages }}">{{ places.paginator.num_pages }}</a>
    {% endif %}

    {% if places.has_next %}
      <a href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ places.next_page_number }}">ë‹¤ìŒ</a>
    {% endif %}
  </div>
  {% endif %}
</div>

<script src="{% static 'js/map.js' %}?v={% now 'U' %}"></script>
<script
src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}&callback=initMap&v=weekly&libraries=marker"
defer
></script>
<script src="{% static 'js/like.js' %}"></script>
<script src="{% static 'js/tabbar.js' %}"></script>
<script src="{% static 'js/script.js' %}"></script>
{% endblock %}
