{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/place_detail.css' %}">

<div class="place-detail container">
  <div class="place-detail__header">
    <h2 class="place-detail__title">{{ place.name }}</h2>

    {% if user.is_authenticated %}
    <form method="post" action="{% url 'places:place_like' place.pk %}" class="like-form">
      {% csrf_token %}
      <button type="submit" class="like-button">
        {% if place.is_liked %}â¤ï¸ ì·¨ì†Œ{% else %}ğŸ¤ ì¢‹ì•„ìš”{% endif %}
      </button>
    </form>
    {% endif %}
  </div>

  <div class="card">
    <div class="map-section-detail"></div>
  </div>

  <div class="card">
    <div class="meta-grid">
      <div class="meta-item meta-item-right">
        <div class="meta-label">ì£¼ì†Œ</div>
        <div class="meta-value">{{ place.address }}</div>
      </div>
      <div class="meta-item meta-item-right">
        <div class="meta-label">ì§€ì—­</div>
        <div class="meta-value">{{ place.region }}</div>
      </div>
      <div class="meta-item">
        <div class="meta-label">ë¶„ë¥˜</div>
        <div class="meta-value">
          {% if place.place_class == 1 %}ë ˆí¬ì¸ {% elif place.place_class == 2 %}ì‡¼í•‘{% elif place.place_class == 3 %}ê´€ê´‘ì§€{% elif place.place_class == 4 %}ë¬¸í™”ì‹œì„¤{% endif %}
        </div>
      </div>
    </div>
  </div>

  <section class="card">
    <h3 class="section-title">ê°œìš”</h3>
    <p class="section-text">{{ place.overview|default:"ê°œìš” ì—†ìŒ" }}</p>
  </section>

  <section class="card">
    <h3 class="section-title">ì„¤ëª…</h3>
    <p class="section-text">{{ place.summary|default:"ì„¤ëª… ì—†ìŒ" }}</p>
  </section>

  <section class="card">
    <h3 class="section-title">íƒœê·¸</h3>
    <ul class="tag-list">
      {% for tag in place.tags.all %}
      <li class="tag">#{{ tag.name }}</li>
      {% empty %}
      <li class="tag tag--empty">#íƒœê·¸ì—†ìŒ</li>
      {% endfor %}
    </ul>
  </section>

  <div class="place-detail__footer">
    <a class="back-link" href="{% url 'places:main' %}">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>
</div>
<!-- ë¸”ë¡œê·¸ í›„ê¸° ì„¹ì…˜ -->
<section class="mt-6">
    <h3>ë¸”ë¡œê·¸ í›„ê¸°</h3>
    <button id="load-blog-reviews" data-place-id="{{ place.id }}">ë¸”ë¡œê·¸ í›„ê¸° ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <ul id="blog-review-list" style="margin-top:10px;"></ul>
</section>

<script>
(function(){
const btn = document.getElementById("load-blog-reviews");
const ul = document.getElementById("blog-review-list");
const clean = (s='') => s.replace(/<[^>]+>/g, '');

btn.addEventListener("click", async () => {
    ul.innerHTML = "<li>ë¡œë”© ì¤‘...</li>";
    try {
    const pid = btn.dataset.placeId;
    const res = await fetch(`/reviews/blogs/${pid}/`);
    const data = await res.json();
    ul.innerHTML = "";
    (data.items || []).forEach(it => {
        const li = document.createElement("li");
        li.innerHTML = `
        <a href="${it.link}" target="_blank" rel="noopener">${clean(it.title)}</a>
        <div>${clean(it.summary)}</div>
        <small>${it.blogger} Â· ${it.postdate}</small>
        `;
        ul.appendChild(li);
    });
    if ((data.items || []).length === 0) {
        ul.innerHTML = "<li>ê´€ë ¨ ë¸”ë¡œê·¸ í›„ê¸°ê°€ ì—†ì–´ìš”.</li>";
    }
    } catch (e) {
    console.error(e);
    ul.innerHTML = "<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.</li>";
    }
});
})();
</script>
{% endblock %}
