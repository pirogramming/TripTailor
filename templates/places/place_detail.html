{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/place_detail.css' %}">

<div class="place-detail container">
  <div class="place-detail__header">
    <h2 class="place-detail__title">{{ place.name }}</h2>

    {% if user.is_authenticated %}
    <form method="post" action="{% url 'places:place_like' place.pk %}" class="like-form">
      {% csrf_token %}
      <button type="submit" class="like-button">
        {% if place.is_liked %}â¤ï¸ ì·¨ì†Œ{% else %}ğŸ¤ ì¢‹ì•„ìš”{% endif %}
      </button>
    </form>
    {% endif %}
  </div>

  <div class="card">
    <div class="map-section-detail"></div>
  </div>

  <div class="card">
    <div class="meta-grid">
      <div class="meta-item meta-item-right">
        <div class="meta-label">ì£¼ì†Œ</div>
        <div class="meta-value">{{ place.address }}</div>
      </div>
      <div class="meta-item meta-item-right">
        <div class="meta-label">ì§€ì—­</div>
        <div class="meta-value">{{ place.region }}</div>
      </div>
      <div class="meta-item">
        <div class="meta-label">ë¶„ë¥˜</div>
        <div class="meta-value">
          {% if place.place_class == 1 %}ë ˆí¬ì¸ {% elif place.place_class == 2 %}ì‡¼í•‘{% elif place.place_class == 3 %}ê´€ê´‘ì§€{% elif place.place_class == 4 %}ë¬¸í™”ì‹œì„¤{% endif %}
        </div>
      </div>
    </div>
  </div>

  <section class="card">
    <h3 class="section-title">ê°œìš”</h3>
    <p class="section-text">{{ place.overview|default:"ê°œìš” ì—†ìŒ" }}</p>
  </section>

  <section class="card">
    <h3 class="section-title">ì„¤ëª…</h3>
    <p class="section-text">{{ place.summary|default:"ì„¤ëª… ì—†ìŒ" }}</p>
  </section>

  <section class="card">
    <h3 class="section-title">íƒœê·¸</h3>
    <ul class="tag-list">
      {% for tag in place.tags.all %}
      <li class="tag">#{{ tag.name }}</li>
      {% empty %}
      <li class="tag tag--empty">#íƒœê·¸ì—†ìŒ</li>
      {% endfor %}
    </ul>
  </section>

  <!-- ë¸”ë¡œê·¸ í›„ê¸° ì„¹ì…˜ -->
  <section class="card">
      <h3 class="section-title">ë¸”ë¡œê·¸ í›„ê¸°</h3>
      <button id="load-blog-reviews" data-place-id="{{ place.id }}" class="tag">ë¸”ë¡œê·¸ í›„ê¸° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <ul id="blog-review-list" style="margin-top:10px;">

      </ul>
  </section>

  <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
  <section class="card">
    <h3 class="section-title">ëŒ“ê¸€</h3>
    
    <!-- CSRF í† í° (JavaScriptìš©) -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    
    <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
    {% if user.is_authenticated %}
    <div class="review-form-section">
      <h4>ëŒ“ê¸€ ì‘ì„±</h4>
      <form method="post" action="{% url 'reviews:place_create' place.id %}" class="review-form" id="review-form">
        {% csrf_token %}
        <div class="form-group">
          <label for="id_title">ì œëª© *</label>
          <input type="text" name="title" id="id_title" class="form-control" required maxlength="200">
        </div>
        
        <div class="form-group">
          <label for="id_rating">í‰ì  *</label>
          <select name="rating" id="id_rating" class="form-control" required>
            <option value="">í‰ì  ì„ íƒ</option>
            <option value="5.0">5.0 - ë§¤ìš° ì¢‹ìŒ</option>
            <option value="4.5">4.5 - ì¢‹ìŒ</option>
            <option value="4.0">4.0 - ë³´í†µ</option>
            <option value="3.5">3.5 - ë³´í†µ</option>
            <option value="3.0">3.0 - ë³´í†µ</option>
            <option value="2.5">2.5 - ë‚˜ì¨</option>
            <option value="2.0">2.0 - ë‚˜ì¨</option>
            <option value="1.5">1.5 - ë§¤ìš° ë‚˜ì¨</option>
            <option value="1.0">1.0 - ë¹„ì¶”ì²œ</option>
            <option value="0.5">0.5 - ë§¤ìš° ë‚˜ì¨</option>
            <option value="0.0">0.0 - ê°€ì§€ë§ˆ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="id_summary">ìš”ì•½ *</label>
          <input type="text" name="summary" id="id_summary" class="form-control" required maxlength="255" placeholder="ê°„ë‹¨í•œ ìš”ì•½ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        
        <div class="form-group">
          <label for="id_content">ë‚´ìš© *</label>
          <textarea name="content" id="id_content" class="form-control" rows="4" required placeholder="ìƒì„¸í•œ í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
        </div>

        <div class="form-group">
          <label for="id_route">ë£¨íŠ¸ *</label>
          <select name="route" id="id_route" class="form-control" required>
            <option value="">ë£¨íŠ¸ ì„ íƒ (í•„ìˆ˜)</option>
            {% for route in user_routes %}
            <option value="{{ route.id }}">{{ route.title }}</option>
            {% endfor %}
          </select>
          <small class="form-text text-muted">ì´ ëŒ“ê¸€ì„ ì—°ê²°í•  ì—¬í–‰ ë£¨íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</small>
        </div>

        <div class="form-group">
          <label>ì´ë¯¸ì§€ URL (ìµœëŒ€ 5ê°œ, ì„ íƒì‚¬í•­)</label>
          <div id="photo-inputs">
            <div class="photo-input-row">
              <input type="url" name="photo_urls[]" class="form-control photo-url-input" placeholder="https://example.com/image1.jpg">
              <div class="photo-preview"></div>
            </div>
          </div>
          <button type="button" id="add-photo-btn" class="btn btn-sm btn-outline-secondary">+ ì´ë¯¸ì§€ ì¶”ê°€</button>
          <small class="form-text text-muted">ëŒ“ê¸€ê³¼ í•¨ê»˜ í‘œì‹œí•  ì´ë¯¸ì§€ì˜ URLì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 5ê°œ)</small>
        </div>
        
        <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
      </form>
    </div>
    {% else %}
    <div class="review-form-section">
      <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="{% url 'account_login' %}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
    </div>
    {% endif %}

    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <div id="review-list">
      <!-- ëŒ“ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      <div class="loading-reviews">ëŒ“ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </section>

  <div class="place-detail__footer">
    <a class="back-link" href="{% url 'places:main' %}">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    <br>
    <a class="route-link" href="{% url 'routes:place_routes' place.id %}">ì´ ì¥ì†Œê°€ í¬í•¨ëœ ë£¨íŠ¸ ë³´ê¸°</a>
  </div>
</div>



<script src="{% static 'js/like.js' %}"></script>
<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', function() {
    loadReviews();
});

// ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
function loadReviews() {
    const reviewList = document.getElementById('review-list');
    if (reviewList) {
        fetch(`{% url 'reviews:htmx_list' place.id %}`)
            .then(response => response.text())
            .then(html => {
                reviewList.innerHTML = html;
                // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ í›„ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                setupDeleteButtons();
            })
            .catch(error => {
                console.error('ëŒ“ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                reviewList.innerHTML = '<p>ëŒ“ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
    }
}

// ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupDeleteButtons() {
    console.log('ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘...');
    const deleteButtons = document.querySelectorAll('.delete-review-btn');
    console.log('ë°œê²¬ëœ ì‚­ì œ ë²„íŠ¼ ê°œìˆ˜:', deleteButtons.length);
    
    deleteButtons.forEach(button => {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        button.removeEventListener('click', handleDeleteClick);
        // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        button.addEventListener('click', handleDeleteClick);
    });
}

// ì‚­ì œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
function handleDeleteClick(event) {
    const button = event.currentTarget;
    const reviewId = button.getAttribute('data-review-id');
    const placeId = button.getAttribute('data-place-id');
    
    console.log('ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨:', reviewId, placeId);
    
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        console.log('ì‚¬ìš©ìê°€ í™•ì¸ì„ í´ë¦­í•¨');
        
        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        console.log('CSRF í† í°:', csrfToken);
        
        // ì‚­ì œ ìš”ì²­ ë³´ë‚´ê¸°
        fetch(`/reviews/place/${placeId}/${reviewId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('ì‘ë‹µ ë°ì´í„°:', data);
            if (data.success) {
                console.log('ì‚­ì œ ì„±ê³µ, ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨');
                // ì„±ê³µ ì‹œ ëŒ“ê¸€ ëª©ë¡ë§Œ ìƒˆë¡œê³ ì¹¨
                loadReviews();
            } else {
                console.log('ì‚­ì œ ì‹¤íŒ¨:', data.message);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(error => {
            console.error('ì‚­ì œ ìš”ì²­ ì˜¤ë¥˜:', error);
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    } else {
        console.log('ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ í´ë¦­í•¨');
    }
}

// ì´ë¯¸ì§€ ì¶”ê°€/ì‚­ì œ ë° ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const addPhotoBtn = document.getElementById('add-photo-btn');
    const photoInputs = document.getElementById('photo-inputs');
    const maxPhotos = 5;

    // ì´ë¯¸ì§€ ì¶”ê°€ ë²„íŠ¼
    if (addPhotoBtn) {
        addPhotoBtn.addEventListener('click', function() {
            const currentPhotos = photoInputs.querySelectorAll('.photo-input-row');
            if (currentPhotos.length < maxPhotos) {
                const newRow = document.createElement('div');
                newRow.className = 'photo-input-row';
                newRow.innerHTML = `
                    <input type="url" name="photo_urls[]" class="form-control photo-url-input" placeholder="https://example.com/image${currentPhotos.length + 1}.jpg">
                    <button type="button" class="btn btn-sm btn-danger remove-photo-btn">ì‚­ì œ</button>
                    <div class="photo-preview"></div>
                `;
                photoInputs.appendChild(newRow);
                
                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
                newRow.querySelector('.remove-photo-btn').addEventListener('click', function() {
                    photoInputs.removeChild(newRow);
                    updateAddButton();
                });
                
                // URL ì…ë ¥ ì´ë²¤íŠ¸
                newRow.querySelector('.photo-url-input').addEventListener('input', handlePhotoUrlInput);
                
                updateAddButton();
            }
        });
    }

    // ì´ë¯¸ì§€ URL ì…ë ¥ ì²˜ë¦¬
    function handlePhotoUrlInput(event) {
        const input = event.target;
        const preview = input.parentElement.querySelector('.photo-preview');
        const url = input.value.trim();
        
        if (url && isValidUrl(url)) {
            preview.innerHTML = `<img src="${url}" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 100px; max-height: 100px; margin: 5px;">`;
        } else {
            preview.innerHTML = '';
        }
    }

    // URL ìœ íš¨ì„± ê²€ì‚¬
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    // ì¶”ê°€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateAddButton() {
        const currentPhotos = photoInputs.querySelectorAll('.photo-input-row');
        if (currentPhotos.length >= maxPhotos) {
            addPhotoBtn.disabled = true;
            addPhotoBtn.textContent = 'ì´ë¯¸ì§€ ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬';
        } else {
            addPhotoBtn.disabled = false;
            addPhotoBtn.textContent = '+ ì´ë¯¸ì§€ ì¶”ê°€';
        }
    }

    // ê¸°ì¡´ ì´ë¯¸ì§€ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ì¶”ê°€
    const existingInputs = photoInputs.querySelectorAll('.photo-url-input');
    existingInputs.forEach(input => {
        input.addEventListener('input', handlePhotoUrlInput);
    });

    // í¼ ì œì¶œ í›„ ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    const reviewForm = document.getElementById('review-form');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function() {
            // í¼ ì œì¶œ í›„ ì ì‹œ ëŒ€ê¸° í›„ ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            setTimeout(function() {
                loadReviews();
            }, 1000);
        });
    }
});
</script>
{% endblock %}
