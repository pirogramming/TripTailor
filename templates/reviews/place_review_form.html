{% extends 'base.html' %}
{% load static %}
{% block rating %}{% if form.instance.pk %}댓글 수정{% else %}댓글 작성{% endif %}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/users/review_form.css' %}">
<div class="place-review-form">
  <div class="place-info">
    <h1>{% if form.instance.pk %}댓글 수정{% else %}댓글 작성{% endif %}</h1>
    <p><strong>장소:</strong> {{ place.name }}</p>
    <p><strong>주소:</strong> {{ place.address }}</p>
  </div>

  <!-- ⚠️ 파일 업로드 시 반드시 enctype 추가 -->
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="form-group mb-3">
      <label for="id_rating">평점 *</label>
      {{ form.rating }}
      {% if form.rating.errors %}
        <div class="text-danger">{{ form.rating.errors }}</div>
      {% endif %}
    </div>
    
    
    <div class="form-group mb-3">
      <label for="id_content">내용 *</label>
      {{ form.content }}
      {% if form.content.errors %}
        <div class="text-danger">{{ form.content.errors }}</div>
      {% endif %}
    </div>

    <!-- ✅ 파일 업로드(다중) + 미리보기 + 최대 5장 -->
    <div class="form-group mb-3">
      <label for="id_photos">이미지 업로드 (최대 5장, 선택)</label>
      <input type="file" id="id_photos" name="photos" class="form-control" accept="image/*" multiple>
      <small class="form-text text-muted">JPG/PNG 등 이미지 파일을 업로드하세요. 최대 5장까지 가능합니다.</small>

      <!-- 기존(수정 화면) 사진 목록: 삭제 체크 가능 -->
      {% if form.instance.pk and form.instance.photos.all %}
      <div class="mt-3">
        <div><strong>현재 등록된 이미지</strong> (삭제할 이미지를 체크하세요)</div>
        <div class="d-flex flex-wrap gap-2 mt-2">
          {% for p in form.instance.photos.all %}
            {% if p.image %}
            <label class="border rounded p-2 d-inline-flex flex-column align-items-center" style="width: 120px;">
              <img src="{{ p.image.url }}" alt="기존 이미지" style="max-width:100%;max-height:100px;object-fit:cover;">
              <input type="checkbox" name="delete_photo_ids" value="{{ p.id }}" class="mt-2">
              <span class="small text-muted">삭제</span>
            </label>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- 새로 업로드하는 파일들의 미리보기 -->
      <div id="photo-previews" class="d-flex flex-wrap gap-2 mt-3"></div>
    </div>
    
    <div class="d-flex justify-content-between">
      <a href="{% url 'places:place_detail' place.id %}" class="btn btn-secondary">취소</a>
      <button type="submit" class="btn btn-primary">
        {% if form.instance.pk %}수정{% else %}작성{% endif %}
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('id_photos');
  const previews = document.getElementById('photo-previews');
  const MAX_FILES = 5;

  // 현재(수정화면) 기존 이미지 개수 반영
  const existingCount = document.querySelectorAll('[name="delete_photo_ids"]').length || 0;

  input.addEventListener('change', function() {
    previews.innerHTML = '';
    const files = Array.from(input.files);

    // 최대 개수: 기존 이미지 포함(삭제 체크는 서버에서 처리되므로 프론트에선 보수적으로 제한)
    if (files.length + existingCount > MAX_FILES) {
      alert(`이미지는 최대 ${MAX_FILES}장까지 업로드할 수 있어요.\n(기존 이미지 포함)`);
      input.value = '';
      return;
    }

    files.forEach(file => {
      if (!file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const wrap = document.createElement('div');
        wrap.className = 'border rounded p-2 d-inline-flex flex-column align-items-center';
        wrap.style.width = '120px';
        wrap.innerHTML = `
          <img src="${e.target.result}" alt="미리보기" style="max-width:100%;max-height:100px;object-fit:cover;">
          <span class="small mt-1 text-truncate" style="max-width:100%;">${file.name}</span>
        `;
        previews.appendChild(wrap);
      };
      reader.readAsDataURL(file);
    });
  });
});
</script>
{% endblock %}
