{% extends 'base.html' %}
{% block rating %}{% if form.instance.pk %}댓글 수정{% else %}댓글 작성{% endif %}{% endblock %}

{% block content %}
<div class="place-review-form">
  <div class="place-info">
    <h1>{% if form.instance.pk %}댓글 수정{% else %}댓글 작성{% endif %}</h1>
    <p><strong>장소:</strong> {{ place.name }}</p>
    <p><strong>주소:</strong> {{ place.address }}</p>
  </div>

  <form method="post">
    {% csrf_token %}
    
    <div class="form-group mb-3">
      <label for="id_rating">평점 *</label>
      <select name="rating" id="id_rating" class="form-control" required>
        <option value="">평점 선택</option>
        <option value="5.0" {% if form.rating.value == "5.0" %}selected{% endif %}>5.0</option>
        <option value="4.5" {% if form.rating.value == "4.5" %}selected{% endif %}>4.5</option>
        <option value="4.0" {% if form.rating.value == "4.0" %}selected{% endif %}>4.0</option>
        <option value="3.5" {% if form.rating.value == "3.5" %}selected{% endif %}>3.5</option>
        <option value="3.0" {% if form.rating.value == "3.0" %}selected{% endif %}>3.0</option>
        <option value="2.5" {% if form.rating.value == "2.5" %}selected{% endif %}>2.5</option>
        <option value="2.0" {% if form.rating.value == "2.0" %}selected{% endif %}>2.0</option>
        <option value="1.5" {% if form.rating.value == "1.5" %}selected{% endif %}>1.5</option>
        <option value="1.0" {% if form.rating.value == "1.0" %}selected{% endif %}>1.0</option>
        <option value="0.5" {% if form.rating.value == "0.5" %}selected{% endif %}>0.5</option>
        <option value="0.0" {% if form.rating.value == "0.0" %}selected{% endif %}>0.0</option>
      </select>
    </div>
    
    <div class="form-group mb-3">
      <label for="id_content">내용 *</label>
      <textarea name="content" id="id_content" class="form-control" rows="4" required placeholder="상세한 후기를 작성해주세요">{{ form.content.value|default:'' }}</textarea>
    </div>

    <div class="form-group mb-3">
      <label>이미지 URL (최대 5개, 선택사항)</label>
      <div id="photo-inputs">
        {% if current_photo_urls %}
          {% for photo_url in current_photo_urls %}
          <div class="photo-input-row">
            <input type="url" name="photo_urls[]" class="form-control photo-url-input" value="{{ photo_url }}" placeholder="https://example.com/image{{ forloop.counter }}.jpg">
            {% if not forloop.first %}
            <button type="button" class="btn btn-sm btn-danger remove-photo-btn">삭제</button>
            {% endif %}
            <div class="photo-preview">
              <img src="{{ photo_url }}" alt="현재 이미지" style="max-width: 100px; max-height: 100px; margin: 5px;">
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="photo-input-row">
            <input type="url" name="photo_urls[]" class="form-control photo-url-input" placeholder="https://example.com/image1.jpg">
            <div class="photo-preview"></div>
          </div>
        {% endif %}
      </div>
      <button type="button" id="add-photo-btn" class="btn btn-sm btn-outline-secondary">+ 이미지 추가</button>
      <small class="form-text text-muted">댓글과 함께 표시할 이미지의 URL을 입력하세요 (최대 5개)</small>
    </div>
    
    <div class="d-flex justify-content-between">
      <a href="{% url 'places:place_detail' place.id %}" class="btn btn-secondary">취소</a>
      <button type="submit" class="btn btn-primary">
        {% if form.instance.pk %}수정{% else %}작성{% endif %}
      </button>
    </div>
  </form>
</div>

<script>
// 이미지 추가/삭제 및 미리보기 기능
document.addEventListener('DOMContentLoaded', function() {
    const addPhotoBtn = document.getElementById('add-photo-btn');
    const photoInputs = document.getElementById('photo-inputs');
    const maxPhotos = 5;

    // 이미지 추가 버튼
    if (addPhotoBtn) {
        addPhotoBtn.addEventListener('click', function() {
            const currentPhotos = photoInputs.querySelectorAll('.photo-input-row');
            if (currentPhotos.length < maxPhotos) {
                const newRow = document.createElement('div');
                newRow.className = 'photo-input-row';
                newRow.innerHTML = `
                    <input type="url" name="photo_urls[]" class="form-control photo-url-input" placeholder="https://example.com/image${currentPhotos.length + 1}.jpg">
                    <button type="button" class="btn btn-sm btn-danger remove-photo-btn">삭제</button>
                    <div class="photo-preview"></div>
                `;
                photoInputs.appendChild(newRow);
                
                // 삭제 버튼 이벤트
                newRow.querySelector('.remove-photo-btn').addEventListener('click', function() {
                    photoInputs.removeChild(newRow);
                    updateAddButton();
                });
                
                // URL 입력 이벤트
                newRow.querySelector('.photo-url-input').addEventListener('input', handlePhotoUrlInput);
                
                updateAddButton();
            }
        });
    }

    // 이미지 URL 입력 처리
    function handlePhotoUrlInput(event) {
        const input = event.target;
        const preview = input.parentElement.querySelector('.photo-preview');
        const url = input.value.trim();
        
        if (url && isValidUrl(url)) {
            preview.innerHTML = `<img src="${url}" alt="미리보기" style="max-width: 100px; max-height: 100px; margin: 5px;">`;
        } else {
            preview.innerHTML = '';
        }
    }

    // URL 유효성 검사
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    // 추가 버튼 상태 업데이트
    function updateAddButton() {
        const currentPhotos = photoInputs.querySelectorAll('.photo-input-row');
        if (currentPhotos.length >= maxPhotos) {
            addPhotoBtn.disabled = true;
            addPhotoBtn.textContent = '이미지 최대 개수 도달';
        } else {
            addPhotoBtn.disabled = false;
            addPhotoBtn.textContent = '+ 이미지 추가';
        }
    }

    // 기존 이미지 입력 필드에 이벤트 추가
    const existingInputs = photoInputs.querySelectorAll('.photo-url-input');
    existingInputs.forEach(input => {
        input.addEventListener('input', handlePhotoUrlInput);
    });

    // 초기 상태 업데이트
    updateAddButton();
});
</script>
{% endblock %}
